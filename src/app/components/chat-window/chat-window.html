<div class="chat-window-wrapper">
  
  <div *ngIf="!conversationId" class="chat-prompt">
    <i class="fa-regular fa-comments"></i>
    <p>Selecione uma conversa para começar o atendimento</p>
  </div>

  <ng-container *ngIf="conversationId">
    
    <div class="header">
      <div class="header-left">
        <h3>{{ currentConversation?.userName | uppercase }}</h3>
        <span class="status-badge" [ngClass]="currentConversation?.status">{{ currentConversation?.status }}</span>
        
        <span *ngIf="currentConversation?.status === 'active' && !isOwner" 
              style="margin-left: 10px; background: #f39c12; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
           <i class="fa-regular fa-eye"></i> Visualizando
        </span>

        <span *ngIf="isSharedWithMe" 
              style="margin-left: 10px; background: #9b59b6; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
           <i class="fa-solid fa-users"></i> Compartilhado
        </span>
      </div>
      
      <div class="header-actions">
        
        <button 
          *ngIf="currentConversation?.status !== 'active' && currentConversation?.status !== 'closed' && !isEditing()"
          (click)="startAttendance()"
          class="start-chat-btn"
          title="Iniciar Atendimento"
          style="margin-right: 10px; background-color: #2ecc71; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
          <i class="fa-solid fa-play"></i> INICIAR
        </button>

        <ng-container *ngIf="isOwner">
            
            <button 
              *ngIf="currentConversation?.status === 'active' && !isEditing()" 
              (click)="openShareModal()" 
              class="share-btn" 
              title="Compartilhar Atendimento"
              style="margin-right: 10px; background-color: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
              <i class="fa-solid fa-share-nodes"></i> Compartilhar
            </button>

            <button 
              *ngIf="currentConversation?.status === 'active' && !isEditing()" 
              (click)="sendAutoClosingMessage()" 
              class="auto-msg-btn" 
              title="Enviar aviso de encerramento"
              style="margin-right: 10px; background-color: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
              <i class="fa-solid fa-bullhorn"></i> Aviso
            </button>
            
            <button 
              *ngIf="currentConversation?.status === 'active' && !isEditing()" 
              (click)="openClosingModal()" 
              class="end-chat-btn"
              [disabled]="!currentConversation?.warningSent"
              [title]="!currentConversation?.warningSent ? 'É necessário enviar o AVISO antes de encerrar' : 'Encerrar Atendimento'"
              [style.opacity]="!currentConversation?.warningSent ? '0.5' : '1'"
              [style.cursor]="!currentConversation?.warningSent ? 'not-allowed' : 'pointer'">
              Encerrar
            </button>
        </ng-container>

        <span *ngIf="currentConversation?.status === 'closed'" class="chat-closed-label">
          Encerrado
        </span>
      </div>
    </div>

    <div *ngIf="currentConversation?.intakeData" class="intake-data">
      
      <div class="intake-header">
        <h4>Dados de Atendimento</h4>
        
        <div class="header-controls">
           <button *ngIf="!isEditing() && isIntakeExpanded() && isOwner" (click)="toggleEdit()" class="edit-btn">Editar</button>
          
          <button (click)="toggleIntake()" class="toggle-btn" title="Mostrar/Esconder Dados">
            <i class="fa-solid" [ngClass]="isIntakeExpanded() ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
          </button>
        </div>
      </div>

      @if (isIntakeExpanded()) {
        
        @if (!isEditing()) {
          <ul class="intake-list">
            <li><strong>Nome:</strong> {{ currentConversation?.intakeData?.nome }}</li>
            <li><strong>Componente:</strong> {{ currentConversation?.intakeData?.componente }}</li> 
            <li><strong>Telefone:</strong> {{ currentConversation?.intakeData?.telefone || '--' }}</li>
            <li>
                <strong>Comunicação:</strong> 
                {{ currentConversation?.intakeData?.modoComunicacao }}
                <ng-container *ngIf="currentConversation?.intakeData?.modoComunicacao === 'GPRS' && currentConversation?.intakeData?.tipoGprs">
                  - {{ currentConversation?.intakeData?.tipoGprs }}
                </ng-container>
                <ng-container *ngIf="currentConversation?.intakeData?.modoComunicacao === 'SATELITAL' && currentConversation?.intakeData?.tipoSatelital">
                  - {{ currentConversation?.intakeData?.tipoSatelital }}
                </ng-container>
                <ng-container *ngIf="currentConversation?.intakeData?.modoComunicacao === 'FIBRA' && currentConversation?.intakeData?.tipoFibra">
                  - {{ currentConversation?.intakeData?.tipoFibra }}
                </ng-container>
              </li>
             <li><strong>Distribuidora:</strong> {{ currentConversation?.intakeData?.distribuidora }}</li>
             <li><strong>IP:</strong> {{ currentConversation?.intakeData?.ip }}</li>
            
            <li><strong>Regional:</strong> {{ currentConversation?.intakeData?.regional }}</li>
            <li><strong>Porta:</strong> {{ currentConversation?.intakeData?.porta }}</li>
            

            <li><strong>Atendimento:</strong> {{ currentConversation?.intakeData?.opcaoAtendimento }}</li>
            <li><strong>Classe:</strong> {{ currentConversation?.intakeData?.classeComponente }} </li>
   
            <li><strong>SE/AL:</strong> {{ currentConversation?.intakeData?.subestacao }} / {{ currentConversation?.intakeData?.alimentador }}</li>

            <li><strong>Modelo:</strong> 
            {{ currentConversation?.intakeData?.modelo || currentConversation?.intakeData?.modeloControle }}  
            @if(currentConversation?.intakeData?.rele) {
            - {{ currentConversation?.intakeData?.rele }}
           }
            
            @if(currentConversation?.intakeData?.rele) {
            <li class="relemagin"> <span ><strong>Relé:</strong> {{ currentConversation?.intakeData?.rele }}</span></li>
            }
            </li>
          </ul>
        }

        @else if (editableData) {
          <form class="intake-edit-form" (ngSubmit)="saveIntakeData()">
            <div class="form-grid">
              
              <div class="form-group">
                <label>1. NOME E SOBRENOME:</label>
                <input type="text" [(ngModel)]="editableData.nome" name="edit-nome" required oninput="this.value = this.value.toUpperCase()">
              </div>

              <div class="form-group">
                <label>2. TELEFONE:</label>
                <input type="text" [(ngModel)]="editableData.telefone" name="edit-telefone" required (input)="formatPhone($event)" placeholder="(99) 99999-9999">
              </div>

              <div class="form-group">
                <label>3. DISTRIBUIDORA:</label>
                <select [(ngModel)]="editableData.distribuidora" name="edit-distribuidora" required>
                  <option value="" disabled>Selecione...</option>
                  @for (estado of distribuidorasKeys; track estado) {
                    <option [value]="estado">{{ estado }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>4. REGIONAL:</label>
                @if (editableData.distribuidora && regionalsByState[editableData.distribuidora]) {
                  <select [(ngModel)]="editableData.regional" name="edit-regional" required>
                    <option value="" disabled>Selecione...</option>
                    @for (regional of regionalsByState[editableData.distribuidora]; track regional) {
                      <option [value]="regional">{{ regional }}</option>
                    }
                  </select>
                } 
                @else {
                  <input type="text" [(ngModel)]="editableData.regional" name="edit-regional" required placeholder="Digite a regional..." oninput="this.value = this.value.toUpperCase()">
                }
              </div>

              <div class="form-group">
                <label>5. OPÇÃO DE ATENDIMENTO:</label>
                <select [(ngModel)]="editableData.opcaoAtendimento" name="edit-opcaoAtendimento" (change)="onOpcaoChange()" required>
                   <option value="CADASTRO DE PORTA HUGHES">CADASTRO DE PORTA HUGHES</option>
                   <option value="COMISSIONAMENTO">COMISSIONAMENTO</option>
                   <option value="TROCA DE PORTA">TROCA DE PORTA</option>
                   <option value="TROCA DE TECNOLOGIA DE COMUNICAÇÃO">TROCA DE TECNOLOGIA DE COMUNICAÇÃO</option>
                   <option value="VERIFICAR COMUNICAÇÃO">VERIFICAR COMUNICAÇÃO</option>
                   <option value="VOLTAR COMUNICAÇÃO">VOLTAR COMUNICAÇÃO</option>
                </select>
              </div>

              <div class="form-group">
                <label>6. SUBESTAÇÃO:</label>
                <input type="text" [(ngModel)]="editableData.subestacao" name="edit-subestacao" maxlength="8" (input)="formatMax8AlphaNumeric($event)" required>
              </div>

              <div class="form-group">
                <label>7. ALIMENTADOR:</label>
                <input type="text" [(ngModel)]="editableData.alimentador" name="edit-alimentador" maxlength="8" (input)="formatMax8AlphaNumeric($event)" required>
              </div>

              <div class="form-group">
                <label>8. COMPONENTE:</label>
                <input type="text" [(ngModel)]="editableData.componente" name="edit-componente" (input)="formatAlphaNumeric($event)" required>
              </div>

              <div class="form-group">
                <label>9. CLASSE:</label>
                <select [(ngModel)]="editableData.classeComponente" name="edit-classe" (change)="onClasseChange()" required>
                  <option value="" disabled>Selecione...</option>
                  @for (classe of classesOptions; track classe) {
                    <option [value]="classe">{{ classe }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>10. MODELO:</label>
                <select [(ngModel)]="editableData.modelo" name="edit-modelo" (change)="onModeloChange()" required>
                  <option value="" disabled>Selecione...</option>
                  @for (modelo of currentModelsOptions; track modelo) {
                    <option [value]="modelo">{{ modelo }}</option>
                  }
                </select>
              </div>

              @if (editableData.classeComponente === 'RELIGADOR' && editableData.modelo) {
                <div class="form-group" style="background-color: #f0f7ff;">
                  <label style="color: #007bff;">↳ RELÉ:</label>
                  <select [(ngModel)]="editableData.rele" name="edit-rele" required>
                    <option value="" disabled>Selecione...</option>
                    @for (rele of currentRelaysOptions; track rele) {
                      <option [value]="rele">{{ rele }}</option>
                    }
                  </select>
                </div>
              }

              <div class="form-group">
                <label>11. COMUNICAÇÃO:</label>
                <select [(ngModel)]="editableData.modoComunicacao" name="edit-modo" required [disabled]="editableData.opcaoAtendimento === 'CADASTRO DE PORTA HUGHES'">
                  <option value="GPRS">GPRS</option>
                  <option value="SATELITAL">SATELITAL</option>
                  <option value="FIBRA">FIBRA</option>
                  <option value="RÁDIO">RÁDIO</option>
                </select>
              </div>

              @if (editableData.modoComunicacao === 'GPRS') {
                <div class="form-group" style="background-color: #f0f7ff;">
                  <label style="color: #007bff;">↳ TIPO GPRS:</label>
                  <select [(ngModel)]="editableData.tipoGprs" name="edit-tipoGprs" (change)="onGprsChange($any($event.target).value)" required>
                    <option value="CAS">CAS</option>
                    <option value="V2COM">V2COM</option>
                    <option value="HORUS">HORUS</option>
                  </select>
                </div>
              }

              @if (editableData.modoComunicacao === 'SATELITAL') {
                <div class="form-group" style="background-color: #f0f7ff;">
                  <label style="color: #007bff;">↳ TIPO SATELITAL:</label>
                  <select [(ngModel)]="editableData.tipoSatelital" name="edit-tipoSatelital" required>
                    <option value="BGAN">BGAN</option>
                    <option value="TELESPAZIO">TELESPAZIO</option>
                  </select>
                </div>
              }

              @if (editableData.modoComunicacao === 'FIBRA') {
                <div class="form-group" style="background-color: #f0f7ff;">
                  <label style="color: #007bff;">↳ TIPO FIBRA:</label>
                  <select [(ngModel)]="editableData.tipoFibra" name="edit-tipoFibra" required>
                    <option value="SERIAL">SERIAL</option>
                    <option value="ETHERNET">ETHERNET</option>
                  </select>
                </div>
              }

              <div class="form-group">
                <label>12. IP:</label>
                @if (editableData.modoComunicacao === 'GPRS' && editableData.tipoGprs === 'CAS') {
                    <input type="text" value="10.1.1.58" disabled style="background-color: #e9ecef;">
                } 
                @else if (editableData.modoComunicacao === 'GPRS' && editableData.tipoGprs === 'V2COM') {
                    <input type="text" value="10.74.150.20" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.modoComunicacao === 'GPRS' && editableData.tipoGprs === 'HORUS') {
                    <input type="text" value="10.82.149.2" disabled style="background-color: #e9ecef;">
                }
                @else {
                    <input type="text" [(ngModel)]="editableData.ip" name="edit-ip" (input)="formatIP($event)" required>
                }
              </div>

              <div class="form-group">
                <label>13. PORTA:</label>
                @if (editableData.modoComunicacao === 'SATELITAL' && editableData.tipoSatelital === 'TELESPAZIO') {
                  <input type="text" value="20000" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.modoComunicacao === 'FIBRA' && editableData.tipoFibra === 'ETHERNET') {
                  <input type="text" value="20000" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.tipoFibra === 'SERIAL' && editableData.distribuidora === 'MA') {
                    <input type="text" value="50002" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.modoComunicacao === 'RÁDIO' && editableData.distribuidora === 'PA') {
                    <input type="text" value="CONSULTAR SCADA" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.modoComunicacao === 'RÁDIO') {
                    <input type="text" value="20000" disabled style="background-color: #e9ecef;">
                }
                @else if (editableData.opcaoAtendimento === 'CADASTRO DE PORTA HUGHES') {
                    <input type="text" value="CONSULTAR VELP" disabled style="background-color: #e9ecef;">
                }
                @else {
                  <input type="text" [(ngModel)]="editableData.porta" name="edit-porta" (input)="formatOnlyNumbers($event)" maxlength="5" required>
                }
              </div>

            </div>
            
            <div class="form-actions">
              <button type="button" (click)="cancelEdit()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        }

      }
    </div>

    <div class="messages-area" #messagesArea> 
      <div class="messages-container">
        <div *ngFor="let msg of (messages$ | async)"
             class="message-bubble"
             [ngClass]="{
               'client': msg.senderId !== currentAdminId,
               'admin': msg.senderId === currentAdminId
             }">
          
          <div class="sender-name">
            {{ msg.senderId === currentAdminId ? 'Você' : currentConversation?.userName }}
          </div>

          @if(msg.text) {
            <p [innerHTML]="msg.text | preformat"></p>
          } 
          @else if (msg.mediaUrl && msg.mediaType === 'image') {
            <a [href]="msg.mediaUrl" target="_blank">
              <img [src]="msg.mediaUrl" alt="Anexo" class="chat-media-img">
            </a>
          } 
          @else if (msg.mediaUrl && msg.mediaType === 'video') {
            <video controls [src]="msg.mediaUrl" class="chat-media-video"></video>
          } 
          @else if (msg.mediaUrl && msg.mediaType === 'audio') {
            <audio controls [src]="msg.mediaUrl" class="chat-media-audio"></audio>
          }

          <span class="timestamp">
            {{ msg.timestamp?.toDate() | date:'HH:mm' }}
          </span>
        </div>
      </div>
    </div>

    <div *ngIf="isUploading()" class="upload-indicator">
      Enviando arquivo... {{ uploadPercentage() | number:'1.0-0' }}%
      <div class="progress-bar"><div class="progress" [style.width.%]="uploadPercentage()"></div></div>
    </div>

    <div *ngIf="isRecording()" class="recording-status">
      <span class="pulsing-dot"></span> Gravando áudio...
    </div>

    <form 
      class="message-form" 
      #chatForm="ngForm" 
      (ngSubmit)="sendMessage(chatForm)"
      *ngIf="currentConversation?.status === 'active' && isOwner"> 
      
      <button type="button" class="icon-btn" (click)="fileInput.click()" [disabled]="isUploading() || isRecording()" title="Anexar arquivo">
        <i class="fa-solid fa-paperclip"></i>
      </button>
      <input type="file" #fileInput (change)="onFileSelected($event)" style="display:none" accept="image/*,video/*,audio/*,application/pdf">

      <button type="button" class="icon-btn mic-btn" [ngClass]="{'recording': isRecording()}" (click)="toggleRecording()" [disabled]="isUploading()" title="Gravar áudio">
        <i class="fa-solid" [ngClass]="isRecording() ? 'fa-stop' : 'fa-microphone'"></i>
      </button>

      <input *ngIf="!isRecording()" type="text" placeholder="Digite sua resposta..." name="message" ngModel autocomplete="off" required>
      
      <button *ngIf="!isRecording()" type="submit" [disabled]="chatForm.invalid || isUploading()">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>
    
    <div *ngIf="currentConversation?.status === 'active' && !isOwner" style="text-align: center; padding: 15px; background: #fff3cd; color: #856404; border-top: 1px solid #ffeeba;">
      <i class="fa-solid fa-lock"></i> Modo Visualização: Este atendimento pertence a <strong>{{ currentConversation?.attendedByEmail }}</strong>.
    </div>

    <div *ngIf="currentConversation?.status !== 'active' && currentConversation?.status !== 'closed'" style="text-align: center; padding: 20px; color: gray;">
        <p>Clique em <strong>INICIAR</strong> para responder este atendimento.</p>
    </div>

  </ng-container>

  <div *ngIf="showClosingModal()" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px; color: #333;">Finalizar Atendimento</h3>
      <p style="margin-bottom: 20px; color: #666;">Preencha os dados abaixo para confirmar o encerramento.</p>

      <form (ngSubmit)="confirmEndChat()" #closingForm="ngForm">
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display:block; font-weight:bold; margin-bottom: 5px;">Status de Comunicação:</label>
          <select [(ngModel)]="closingData.statusComunicacao" name="statusComunicacao" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="SIM">Sim</option>
            <option value="NÃO">Não</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display:block; font-weight:bold; margin-bottom: 5px;">Validação Assertiva de Solicitação:</label>
          <select [(ngModel)]="closingData.validacaoAssertiva" name="validacaoAssertiva" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="SIM">Sim</option>
            <option value="NÃO">Não</option>
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display:block; font-weight:bold; margin-bottom: 5px;">Observação de Problema:</label>
          <textarea 
            [(ngModel)]="closingData.obsProblema" 
            name="obsProblema" 
            rows="3" 
            placeholder="Descreva o problema encontrado..."
            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; resize: vertical;"></textarea>
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
          <label style="display:block; font-weight:bold; margin-bottom: 5px;">Observação de Solução:</label>
          <textarea 
            [(ngModel)]="closingData.obsSolucao" 
            name="obsSolucao" 
            rows="3" 
            placeholder="Descreva a solução aplicada..."
            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; resize: vertical;"></textarea>
        </div>

        <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="btn-cancel" (click)="closeClosingModal()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          
          <button type="submit" class="btn-confirm" [disabled]="isClosing()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
            {{ isClosing() ? 'Encerrando...' : 'OK / Encerrar' }}
          </button>
        </div>

      </form>
    </div>
  </div>

  <div *ngIf="showShareModal()" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <h3 style="margin-bottom: 20px; color: #333;">Compartilhar Atendimento</h3>
      <p style="margin-bottom: 20px; color: #666;">Digite o e-mail do atendente com quem deseja compartilhar este chamado.</p>

      <form (ngSubmit)="confirmShare()" #shareForm="ngForm">
        <div class="form-group" style="margin-bottom: 20px;">
          <label style="display:block; font-weight:bold; margin-bottom: 5px;">E-mail do Atendente:</label>
          <input 
            type="email" 
            [(ngModel)]="emailToShare" 
            name="shareEmail" 
            required 
            placeholder="exemplo@empresa.com"
            style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
        </div>

        <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="btn-cancel" (click)="closeShareModal()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          <button type="submit" class="btn-confirm" [disabled]="!emailToShare" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
            Compartilhar
          </button>
        </div>
      </form>
    </div>
  </div>

</div>