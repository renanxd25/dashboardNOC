<div class="chat-window-wrapper">
  
  <div *ngIf="!conversationId" class="chat-prompt">
    Selecione uma conversa para começar
  </div>

  <ng-container *ngIf="conversationId">
    
    <div class="header">
      <h3>{{ currentConversation?.userName || 'Carregando...' }}</h3>
      <button 
        *ngIf="currentConversation?.status !== 'closed' && !isEditing()" 
        (click)="endChat()" 
        class="end-chat-btn">
        Encerrar Atendimento
      </button>
      <span *ngIf="currentConversation?.status === 'closed'" class="chat-closed-label">
        Encerrado
      </span>
    </div>

    <div *ngIf="currentConversation?.intakeData" class="intake-data">
      
      <div class="intake-header">
        <h4>Dados de Atendimento</h4>
        <button *ngIf="!isEditing()" (click)="toggleEdit()" class="edit-btn">
          Editar
        </button>
      </div>

      @if (!isEditing()) {
        <ul class="intake-list">
          <li><strong>Nome:</strong> {{ currentConversation?.intakeData?.nome }}</li>
          <li><strong>Distribuidora:</strong> {{ currentConversation?.intakeData?.distribuidora }}</li>
          <li><strong>Regional:</strong> {{ currentConversation?.intakeData?.regional }}</li>
          <li><strong>Atendimento:</strong> {{ currentConversation?.intakeData?.opcaoAtendimento }}</li>
          <li><strong>SE/AL:</strong> {{ currentConversation?.intakeData?.siglaSEAL }}</li>
          <li><strong>Componente:</strong> {{ currentConversation?.intakeData?.componente }}</li>
          <li><strong>Modelo:</strong> {{ currentConversation?.intakeData?.modeloControle }}</li>
          <li><strong>Comunicação:</strong> {{ currentConversation?.intakeData?.modoComunicacao }}</li>
          <li><strong>IP:</strong> {{ currentConversation?.intakeData?.ip }}</li>
          <li><strong>Porta:</strong> {{ currentConversation?.intakeData?.porta }}</li>
        </ul>
      }

      @else if (editableData) {
        <form class="intake-edit-form" (ngSubmit)="saveIntakeData()">
          <div class="form-grid">
            
            <div class="form-group">
              <label for="edit-nome">Nome</label>
              <input type="text" id="edit-nome" name="edit-nome" [(ngModel)]="editableData.nome" required>
            </div>
            
            <div class="form-group">
              <label for="edit-dist">Distribuidora</label>
              <select id="edit-dist" name="edit-dist" [(ngModel)]="editableData.distribuidora" required>
                <option value="MA">MA</option>
                <option value="PA">PA</option>
                <option value="PI">PI</option>
                <option value="AP">AP</option>
                <option value="RS">RS</option>
                <option value="GO">GO</option>
                <option value="AL">AL</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="edit-regional">Regional</label>
              <input type="text" id="edit-regional" name="edit-regional" [(ngModel)]="editableData.regional" required>
            </div>
            <div class="form-group">
              <label for="edit-atend">Atendimento</label>
              <select id="edit-atend" name="edit-atend" [(ngModel)]="editableData.opcaoAtendimento" required>
                <option value="COMISSIONAMENTO">COMISSIONAMENTO</option>
                <option value="VERIFICAR COMUNICAÇÃO">VERIFICAR COMUNICAÇÃO</option>
                <option value="CADASTRO DE PORTA HUGHES">CADASTRO DE PORTA HUGHES</option>
                <option value="TROCA DE PORTA GPRS">TROCA DE PORTA GPRS</option>
                <option value="TROCA DE TECNOLOGIA DE COMUNICAÇÃO">TROCA DE TECNOLOGIA DE COMUNICAÇÃO</option>
                <option value="VOLTAR COMUNICAÇÃO">VOLTAR COMUNICAÇÃO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-seal">SE/AL</label>
              <input type="text" id="edit-seal" name="edit-seal" [(ngModel)]="editableData.siglaSEAL" required>
            </div>
            <div class="form-group">
              <label for="edit-comp">Componente</label>
              <input type="text" id="edit-comp" name="edit-comp" [(ngModel)]="editableData.componente" required>
            </div>
            <div class="form-group">
              <label for="edit-modelo">Modelo</label>
              <select id="edit-modelo" name="edit-modelo" [(ngModel)]="editableData.modeloControle" required>
                <option value="ADATECH">ADATECH</option>
                <option value="SEL 651R">SEL 651R</option>
                <option value="SEL 751">SEL 751</option>
                <option value="ADVC3">ADVC3</option>
                <option value="ADVC">ADVC</option>
                <option value="NOJA">NOJA</option>
                <option value="TAVRIDA">TAVRIDA</option>
                <option value="RUA">RUA</option>
                <option value="TAPELETRO">TAPELETRO</option>
                <option value="CTR2">CTR2</option>
                <option value="CTR3">CTR3</option>
                <option value="FORM6">FORM6</option>
                <option value="G&W">G&W</option>
                <option value="NENHUM">NENHUM</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-com">Comunicação</label>
              <select id="edit-com" name="edit-com" [(ngModel)]="editableData.modoComunicacao" required>
                <option value="GPRS">GPRS</option>
                <option value="BGAN">BGAN</option>
                <option value="TELESPAZIO">TELESPAZIO</option>
                <option value="RÁDIO">RÁDIO</option>
                <option value="V2COM">V2COM</option>
                <option value="FIBRA">FIBRA</option>
                <option value="KOALA">KOALA</option>
                <option value="SENSOR MT">SENSOR MT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-ip">IP</label>
              <input type="text" id="edit-ip" name="edit-ip" [(ngModel)]="editableData.ip" required>
            </div>
            <div class="form-group">
              <label for="edit-porta">Porta</label>
              <input type="text" id="edit-porta" name="edit-porta" [(ngModel)]="editableData.porta" required>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" (click)="cancelEdit()" class="btn-cancel">Cancelar</button>
            <button type="submit" class="btn-save">Salvar Alterações</button>
          </div>
        </form>
      }
    </div>
    <div class="messages-area" #messagesArea> 
      <div class="messages-container">
        <div *ngFor="let msg of (messages$ | async)"
            class="message-bubble"
            [ngClass]="{
              'client': msg.senderId !== currentAdminId,
              'admin': msg.senderId === currentAdminId
            }">
          <p [innerHTML]="msg.text | preformat"></p>
        </div>
      </div>
    </div>

    <form 
      class="message-form" 
      #chatForm="ngForm" 
      (ngSubmit)="sendMessage(chatForm)"
      *ngIf="currentConversation?.status !== 'closed'"> 
      
      <input type="text" placeholder="Digite sua resposta..." name="message" ngModel required>
      <button type="submit" [disabled]="chatForm.invalid">Enviar</button>
    </form>

  </ng-container>
</div>