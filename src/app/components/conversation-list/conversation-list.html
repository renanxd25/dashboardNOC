<div class="export-section">
  <label style="font-size: 0.85rem; font-weight: bold; color: #FFF; display: block; margin-bottom: 5px;">
          Exportar todos os atendimentos
  </label>
  <button (click)="exportAll()" [disabled]="isLoading()">
    {{ isLoading() ? 'Exportando...' : 'Exportar Todos' }}
  </button>

  <div class="date-range">
    <h5>Exportar por Período</h5>
    <div class="date-inputs">
      <div>
        <label for="startDate">De:</label>
        <input type="date" #startDate>
      </div>
      <div>
        <label for="endDate">Até:</label>
        <input type="date" #endDate>
      </div>
    </div>
    <button (click)="exportByDateRange(startDate.value, endDate.value)" [disabled]="isLoading()">
      {{ isLoading() ? 'Exportando...' : 'Exportar Período' }}
    </button>
  </div>
</div>

<div class="filter-container" style="padding: 10px 15px; border-bottom: 1px solid #ddd; background: #0e2746;">
  
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    
    <div style="flex: 2; min-width: 200px;">
      <label style="font-size: 0.85rem; font-weight: bold; color: #FFF; display: block; margin-bottom: 5px;">
        Filtrar por Tipo:
      </label>
      <select 
        [ngModel]="selectedFilter" 
        (ngModelChange)="onFilterChange($event)"
        style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem;">
        <option value="">TODOS OS SERVIÇOS</option>
        
        @for (option of filterOptions; track option) {
          <option [value]="option">
            {{ getFilterLabel(option) }} ({{ servicePriorities[option] || 0 }})
          </option>
        }

      </select>
    </div>

    <div style="flex: 1; min-width: 120px;">
      <label style="font-size: 0.85rem; font-weight: bold; color: #FFF; display: block; margin-bottom: 5px;">
        Distribuidora:
      </label>
      <select 
        [ngModel]="selectedDistributor" 
        (ngModelChange)="onDistributorChange($event)"
        style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem;">
        <option value="">TODAS</option>
        @for (dist of distributorOptions; track dist) {
          <option [value]="dist">{{ dist }}</option>
        }
      </select>
    </div>

  </div>
</div>

<div class="lists-wrapper">
  
  <h4 class="list-header">Fila de Atendimento</h4>
  
  @if (queuedConversations$ | async; as conversations) {
    @if (conversations.length === 0) {
      <div class="empty-list-label">Nenhum item na fila com os filtros atuais.</div>
    }
    <ul class="convo-list">
      @for (convo of conversations; track convo.id; let i = $index) {
        <li 
          class="convo-item"
          (click)="selectConversation(convo.id!, 'queued')" [class.selected]="convo.id === currentSelectedId">
          <div class="item-header">
            
            <span class="queue-position" title="Posição na fila">
              {{ i + 1 }}º
            </span>

            <h4>{{ convo.userName }}</h4>
          </div>
          
          <p>
            {{ getAbbreviatedService(convo.intakeData?.opcaoAtendimento) }} | DIST.: {{convo.intakeData?.distribuidora}}
          </p>
        </li>
      }
    </ul>
  } @else {
    <div class="loading">Carregando fila...</div>
  }


  <h4 class="list-header">Atendimentos Inicializados</h4>
  @if (activeConversations$ | async; as conversations) {
    @if (conversations.length === 0) {
      <div class="empty-list-label">Nenhum atendimento ativo.</div>
    }
    <ul class="convo-list">
      @for (convo of conversations; track convo.id) {
        <li 
          class="convo-item"
          (click)="selectConversation(convo.id!, 'active')" 
          [class.selected]="convo.id === currentSelectedId"
          [ngClass]="{ 'closed': convo.status === 'closed' }"
          [style.border-left]="(convo.attendedBy !== (auth.currentUser?.uid) && !isSharedWithMe(convo)) ? '4px solid #f39c12' : (isSharedWithMe(convo) ? '4px solid #9b59b6' : '4px solid #2ecc71')">
          
          <div class="item-header">
            
            @if (convo['attendedByEmail']) {
              <div 
                class="agent-avatar" 
                [style.background-color]="getAvatarColor(convo['attendedByEmail'])"
                [title]="convo['attendedByEmail']">
                {{ getAvatarInitials(convo['attendedByEmail']) }}
              </div>
            }

            <h4>{{ convo.userName }}</h4>
          </div>

          @if (convo.attendedBy !== (auth.currentUser?.uid) && !isSharedWithMe(convo)) {
            <small style="color: #e67e22; font-weight: bold; font-size: 0.7rem; display: block; margin-bottom: 2px;">
              <i class="fa-regular fa-eye"></i> Visualizando
            </small>
          }
          @else if (isSharedWithMe(convo)) {
            <small style="color: #9b59b6; font-weight: bold; font-size: 0.7rem; display: block; margin-bottom: 2px;">
                <i class="fa-solid fa-users"></i> Compartilhado
            </small>
          }
          
          <p>{{ convo.lastMessage?.text }}</p>
          <p style="font-size: 0.75rem; color: #ffffff; margin-top: 2px;">
            {{ getAbbreviatedService(convo.intakeData?.opcaoAtendimento) }}  | DIST.: {{convo.intakeData?.distribuidora}}
          </p>
        </li>
      }
    </ul>
  } @else {
    <div class="loading">Carregando atendimentos...</div>
  }
  
</div>